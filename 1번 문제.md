# 1. 동시에 같은 `DB Table row` 를 업데이트 하는 상황을 방어하기 위해 어떻게 개발하실 건지 설명해 주세요.

특정 int 데이터 100 이 저장되어있는 row 를 업데이트 하기 위한 2개의 요청(A 요청, B 요청 이라 가정) 이 동시에 들어온 상황이라고 생각해보겠습니다.

(데이터베이스에 접근하는 각 요청을 하나의 트랜잭션으로 생각하겠습니다.)

A 요청은 기존 데이터에서 + 20 업데이트 하길 원하고 B 요청은 기존 데이터에서 - 20 을 업데이트 하길 원합니다.

이때 데이터베이스의 락 을 사용하지 않는다면 A 요청은 100 + 20, B 요청은 100 - 20 으로 순차적으로 데이터가 갱신되지 않고 기존의 값 100 에서 서로의 업데이트를 수행하고 마지막에 커밋된 값이 남게 됩니다. 즉, 커밋되지 않은 데이를 덮어씌우게 되며 값에 손실이 발생하게 됩니다. (이상적인 상황은 동시에 +20, -20 요청이 들어왔기에 100 + 20 - 20 = 100 이 남아 있길 기대하였을 것입니다.)

위와 같은 상황을 `변경 유실 (Lost Update)` 라고 합니다.

대규모 요청이 들어오게 된다면 이러한 문제가 엄청난 문제가 될 수 있습니다. 

따라서 저희는 데이터베이스의 락을 이용하여 동시성 제어를 진행해야 이 문제를 해결할 수 있습니다.

락은 크게 데이터를 읽을 때 사용하는 공유 락과 데이터를 쓸 때 사용하는 베타 락이 있습니다. 저희는 동시 update 를 해결해야 하기 때문에 여러 요청에 대한 트랜잭션이 베타 락을 반드시 사용해야 합니다.



여기서 저희가 고려해야 할 점은 여러 요청에 대한 **블로킹 현상**과 **데드락 현상**이 발생하지 않도록 해야합니다.

**블로킹 현상**은 베타 락을 사용할 때 다른 요청에 대한 트랜잭션이 락을 얻기 위해 경합하고 대기하는 현상을 말합니다.

개발자는 어플리케이션을 개발할 때 이 상황을 반드시 인지하고 블로킹 상황을 최소화 하도록 프로그래밍에 적용해야 합니다.

- 트랜잭션이 너무 길다면 블로킹이 걸릴 확률이 늘어나기에 트랜잭션 단위를 짧게 가져가도록 설계하는 것이 좋습니다.
- 트랜잭션의 격리 수준을 불필요하게 상향하게 되면 블로킹에 걸릴 확률이 높아집니다. 상황에 따라 격리 수준을 하향 조정하는 것이 좋습니다.
- 락의 대기시간을 조절하여 적절한 튜닝을 진행할 수 있습니다.

**데드락 현상**은 두 트랜잭션이 각각의 락을 설정하고, 서로의 락에 접근할 경우, 이미 각각의 트랜잭션이 락을 설정해 두었기 떄문에 양쪽 트랜잭션 모두 영원히 처리되지 않는 현상입니다.

이러한 문제를 해결하기 위해서는 개발자는 데드락이 발생하지 않도록 

- 데이터에 접근하는 순서를 동일하게 해야 합니다. 

만약 어떤 로직이 A 데이터를 업데이트후 B 데이터를 업데이트 하는데, 다른 로직에서 B 데이터를 업데이트후 A 데이터를 업데이트 한다면 데드락이 걸릴 확률이 높아집니다.
